---
import ProjectItem from "./ProjectItem.astro";
import { projectsList } from "../data/projects";
---

<div id="carousel-wrapper">
  <div class="flex overflow-x-hidden px-2 md:px-0 pt-20">
    <div class="flex items-end z-0">
      <h2
        class="font-bold text-text-dark text-5xl uppercase transform rotate-180 inline-block mr-6 z-20 hidden sm:block"
        style="writing-mode: vertical-rl;"
      >
        Projects
      </h2>
    </div>
    <div class="overflow-hidden flex-1 pl-2">
      <div
        id="carousel-track"
        class="flex items-stretch gap-6 duration-500 relative"
        style="transform: translateX(0)"
      >
        {/* Render cards 3x for seamless infinite loop */}
        {[...projectsList, ...projectsList, ...projectsList].map((item) => (
          <ProjectItem {...item} class="w-full shrink-0" />
        ))}
      </div>
    </div>
  </div>
  <div class="flex items-center gap-4 mt-8 ml-[4.3rem]">
    <button id="carousel-prev" class="cursor-pointer" aria-label="Previous">
      <svg viewBox="0 0 15 15" class="w-6 h-6 fill-current"><path d="M6.854 3.146a.5.5 0 0 1 0 .708L3.707 7H12.5a.5.5 0 0 1 0 1H3.707l3.147 3.146a.5.5 0 0 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 0 1 .708 0z"/></svg>
    </button>
    <button id="carousel-next" class="cursor-pointer" aria-label="Next">
      <svg viewBox="0 0 15 15" class="w-6 h-6 fill-current"><path d="M8.146 3.146a.5.5 0 0 0 0 .708L11.293 7H2.5a.5.5 0 0 0 0 1h8.793l-3.147 3.146a.5.5 0 0 0 .708.708l4-4a.5.5 0 0 0 0-.708l-4-4a.5.5 0 0 0-.708 0z"/></svg>
    </button>
    <div id="carousel-dots" class="h-14 flex justify-between items-end w-14 ml-2">
      {projectsList.map((_, index) => (
        <div
          data-index={index}
          class:list={[
            "carousel-dot w-1 bg-primary-dark duration-300 rounded-t-sm cursor-pointer",
            index === 0 ? "h-10" : "h-3",
          ]}
        />
      ))}
    </div>
  </div>
</div>

<script>
  const track = document.getElementById("carousel-track")!;
  const prevBtn = document.getElementById("carousel-prev")!;
  const nextBtn = document.getElementById("carousel-next")!;
  const dots = document.querySelectorAll<HTMLElement>(".carousel-dot");
  const realCount = dots.length; // original number of projects
  // Track starts at the middle set so we can go backwards from the start
  let index = realCount;

  function getStep() {
    const trackWidth = track.parentElement!.clientWidth;
    const gap = 24;
    return trackWidth + gap;
  }

  function jumpWithoutTransition(newIndex: number) {
    track.style.transition = "none";
    index = newIndex;
    track.style.transform = `translateX(-${index * getStep()}px)`;
    // Force reflow so the jump is instant
    track.offsetHeight;
    track.style.transition = "";
  }

  function moveTo(newIndex: number) {
    index = newIndex;
    track.style.transform = `translateX(-${index * getStep()}px)`;
    updateDots();
  }

  function updateDots() {
    const realIndex = ((index % realCount) + realCount) % realCount;
    dots.forEach((dot, i) => {
      dot.classList.toggle("h-10", i === realIndex);
      dot.classList.toggle("h-3", i !== realIndex);
    });
  }

  // After each transition, silently reset to the middle set if we drifted out
  track.addEventListener("transitionend", () => {
    if (index >= realCount * 2) {
      jumpWithoutTransition(index - realCount);
    } else if (index < realCount) {
      jumpWithoutTransition(index + realCount);
    }
  });

  prevBtn.addEventListener("click", () => moveTo(index - 1));
  nextBtn.addEventListener("click", () => moveTo(index + 1));

  dots.forEach((dot) => {
    dot.addEventListener("click", () => {
      const target = parseInt(dot.dataset.index!);
      // Move to that position within the middle set
      moveTo(realCount + target);
    });
  });

  window.addEventListener("resize", () => {
    track.style.transform = `translateX(-${index * getStep()}px)`;
  });

  // Initialize at the start of the middle set
  jumpWithoutTransition(realCount);
</script>
